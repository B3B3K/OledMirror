#include <WiFi.h>
#include <WiFiUdp.h>
#include <Wire.h>

// WiFi Bilgileri
const char* ssid = "0xFF";
const char* password = "66666666";

// UDP
WiFiUDP udp;
const uint16_t localPort = 8888;
unsigned long lastPacketTime = 0;
int currentPing = 0;

// OLED SSD1306 128x64
#define OLED_ADDR 0x3C
#define BUFFER_SIZE 1024      // 128*64/8 (Tüm ekran tamponu)
#define STATUS_BAR_SIZE 256   // 128*16/8 (İlk 16 piksel / 2 Sayfa)

uint8_t displayBuffer[BUFFER_SIZE];
uint8_t statusBar[STATUS_BAR_SIZE]; // 2 sayfalık (16 piksel) sarı alan için

// I2C pinleri (ESP-C3)
#define SDA_PIN 21
#define SCL_PIN 20

// 5x7 Font (ASCII)
const uint8_t font5x7[][5] = {
  {0x00, 0x00, 0x00, 0x00, 0x00}, // Space
  {0x00, 0x00, 0x5F, 0x00, 0x00}, // !
  {0x00, 0x07, 0x00, 0x07, 0x00}, // "
  {0x14, 0x7F, 0x14, 0x7F, 0x14}, // #
  {0x24, 0x2A, 0x7F, 0x2A, 0x12}, // $
  {0x23, 0x13, 0x08, 0x64, 0x62}, // %
  {0x36, 0x49, 0x55, 0x22, 0x50}, // &
  {0x00, 0x05, 0x03, 0x00, 0x00}, // '
  {0x00, 0x1C, 0x22, 0x41, 0x00}, // (
  {0x00, 0x41, 0x22, 0x1C, 0x00}, // )
  {0x08, 0x2A, 0x1C, 0x2A, 0x08}, // *
  {0x08, 0x08, 0x3E, 0x08, 0x08}, // +
  {0x00, 0x50, 0x30, 0x00, 0x00}, // ,
  {0x08, 0x08, 0x08, 0x08, 0x08}, // -
  {0x00, 0x60, 0x60, 0x00, 0x00}, // .
  {0x20, 0x10, 0x08, 0x04, 0x02}, // /
  {0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0
  {0x00, 0x42, 0x7F, 0x40, 0x00}, // 1
  {0x42, 0x61, 0x51, 0x49, 0x46}, // 2
  {0x21, 0x41, 0x45, 0x4B, 0x31}, // 3
  {0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
  {0x27, 0x45, 0x45, 0x45, 0x39}, // 5
  {0x3C, 0x4A, 0x49, 0x49, 0x30}, // 6
  {0x01, 0x71, 0x09, 0x05, 0x03}, // 7
  {0x36, 0x49, 0x49, 0x49, 0x36}, // 8
  {0x06, 0x49, 0x49, 0x29, 0x1E}, // 9
  {0x00, 0x36, 0x36, 0x00, 0x00}, // :
  {0x00, 0x56, 0x36, 0x00, 0x00}, // ;
  {0x00, 0x08, 0x14, 0x22, 0x41}, // <
  {0x14, 0x14, 0x14, 0x14, 0x14}, // =
  {0x41, 0x22, 0x14, 0x08, 0x00}, // >
  {0x02, 0x01, 0x51, 0x09, 0x06}, // ?
  {0x32, 0x49, 0x79, 0x41, 0x3E}, // @
  {0x7E, 0x11, 0x11, 0x11, 0x7E}, // A
  {0x7F, 0x49, 0x49, 0x49, 0x36}, // B
  {0x3E, 0x41, 0x41, 0x41, 0x22}, // C
  {0x7F, 0x41, 0x41, 0x22, 0x1C}, // D
  {0x7F, 0x49, 0x49, 0x49, 0x41}, // E
  {0x7F, 0x09, 0x09, 0x01, 0x01}, // F
  {0x3E, 0x41, 0x41, 0x51, 0x32}, // G
  {0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
  {0x00, 0x41, 0x7F, 0x41, 0x00}, // I
  {0x20, 0x40, 0x41, 0x3F, 0x01}, // J
  {0x7F, 0x08, 0x14, 0x22, 0x41}, // K
  {0x7F, 0x40, 0x40, 0x40, 0x40}, // L
  {0x7F, 0x02, 0x04, 0x02, 0x7F}, // M
  {0x7F, 0x04, 0x08, 0x10, 0x7F}, // N
  {0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
  {0x7F, 0x09, 0x09, 0x09, 0x06}, // P
  {0x3E, 0x41, 0x51, 0x21, 0x5E}, // Q
  {0x7F, 0x09, 0x19, 0x29, 0x46}, // R
  {0x46, 0x49, 0x49, 0x49, 0x31}, // S
  {0x01, 0x01, 0x7F, 0x01, 0x01}, // T
  {0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
  {0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
  {0x7F, 0x20, 0x18, 0x20, 0x7F}, // W
  {0x63, 0x14, 0x08, 0x14, 0x63}, // X
  {0x03, 0x04, 0x78, 0x04, 0x03}, // Y
  {0x61, 0x51, 0x49, 0x45, 0x43}, // Z
};

void oledCommand(uint8_t cmd) {
  Wire.beginTransmission(OLED_ADDR);
  Wire.write(0x00);
  Wire.write(cmd);
  Wire.endTransmission();
}

void oledInit() {
  delay(100);
  oledCommand(0xAE); oledCommand(0xD5); oledCommand(0x80);
  oledCommand(0xA8); oledCommand(0x3F); oledCommand(0xD3);
  oledCommand(0x00); oledCommand(0x40); oledCommand(0x8D);
  oledCommand(0x14); oledCommand(0x20); oledCommand(0x00);
  oledCommand(0xA1); oledCommand(0xC8); oledCommand(0xDA);
  oledCommand(0x12); oledCommand(0x81); oledCommand(0xCF);
  oledCommand(0xD9); oledCommand(0xF1); oledCommand(0xDB);
  oledCommand(0x40); oledCommand(0xA4); oledCommand(0xA6);
  oledCommand(0xAF);
}

// x: sütun, page: 0 veya 1 (sarı alanın satırları)
void drawChar(uint8_t x, uint8_t page, char c) {
  if (c < 32 || c > 90) c = 32;
  const uint8_t* charData = font5x7[c - 32];
  uint16_t offset = page * 128;
  
  for (uint8_t i = 0; i < 5 && (x + i) < 128; i++) {
    statusBar[offset + x + i] = charData[i];
  }
}

void drawText(uint8_t x, uint8_t page, const char* text) {
  uint8_t pos = x;
  while (*text && pos < 128) {
    drawChar(pos, page, *text);
    pos += 6;
    text++;
  }
}

void updateStatusDisplay() {
  memset(statusBar, 0, STATUS_BAR_SIZE);
  
  // Satır 0: Ping ve Kendi IP
  String line1 = "CLI: " + WiFi.localIP().toString();
  drawText(0, 0, line1.c_str());
  
  // Satır 1: Sunucu IP
  String line2 = "SRV: " + udp.remoteIP().toString();
  drawText(0, 1, line2.c_str());

  // Ayırıcı Çizgi (16. pikselde)
  for (int i = 0; i < 128; i++) {
    statusBar[128 + i] |= 0x80; 
  }
}

void oledDisplay() {
  // 1. Status Bar Gönderimi (Page 0 ve 1)
  oledCommand(0x21); oledCommand(0); oledCommand(127);
  oledCommand(0x22); oledCommand(0); oledCommand(1);
  
  for (uint16_t i = 0; i < STATUS_BAR_SIZE; i += 16) {
    Wire.beginTransmission(OLED_ADDR);
    Wire.write(0x40);
    for (uint8_t j = 0; j < 16; j++) {
      Wire.write(statusBar[i + j]);
    }
    Wire.endTransmission();
  }
  
  // 2. Görüntü Alanı Gönderimi (Page 2'den 7'ye)
  oledCommand(0x21); oledCommand(0); oledCommand(127);
  oledCommand(0x22); oledCommand(2); oledCommand(7);
  
  // UDP'den gelen verinin ilk 256 baytı (sarı alan) atlanıyor, 
  // kalan veri ekranın mavi kısmına basılıyor.
  for (uint16_t i = 256; i < BUFFER_SIZE; i += 16) {
    Wire.beginTransmission(OLED_ADDR);
    Wire.write(0x40);
    for (uint8_t j = 0; j < 16; j++) {
      Wire.write(displayBuffer[i + j]);
    }
    Wire.endTransmission();
  }
}

void setup() {
  Wire.begin(SDA_PIN, SCL_PIN);
  Wire.setClock(400000);
  oledInit();
  
  memset(displayBuffer, 0, BUFFER_SIZE);
  updateStatusDisplay();
  oledDisplay();

  WiFi.begin(ssid, password);
  while (WiFi.status() != WL_CONNECTED) {
    delay(500);
  }
  
  udp.begin(localPort);
  updateStatusDisplay();
  oledDisplay();
}

void loop() {
  int packetSize = udp.parsePacket();
  
  if (packetSize) {
    if (packetSize == BUFFER_SIZE) {
      // Ping hesaplama (iki paket arası süre)
      unsigned long now = millis();
      currentPing = now - lastPacketTime;
      lastPacketTime = now;

      udp.read(displayBuffer, BUFFER_SIZE);
      updateStatusDisplay();
      oledDisplay();
    } else {
      while (udp.available()) udp.read();
    }
  }
  delay(1);
}
